<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”®åç ”å‘æ§åˆ¶å°</title>
    <style>
        /* --- æ ¸å¿ƒï¼šIDE æ·±è“ç°ä¸»é¢˜ --- */
        :root {
            --bg-color: #23272e;
            --text-main: #abb2bf;     
            --text-dim: #5c6370;      
            --accent-line: #3b4048;
            --hover-bg: #2c313a;      
            --default-dot: #5c6370;
            --commit-blue: #61afef;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: 30px 50px; 
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { margin: 0; font-size: 22px; color: #fff; font-weight: bold; }

        .header-actions { display: flex; gap: 10px; }
        .btn { text-decoration: none; padding: 6px 14px; border-radius: 4px; font-size: 13px; cursor: pointer; display: flex; align-items: center; border: 1px solid transparent; transition: 0.2s; font-weight: 500;}
        .btn-refresh { background-color: #2c313a; color: #abb2bf; }
        .btn-refresh:hover { background-color: #3e4451; color: #fff; }
        .btn-add { background-color: #98c379; color: #23272e; font-weight: bold; }
        .btn-add:hover { background-color: #7eb05e; }

        .issue-list { 
            list-style: none; padding: 0; margin: 0; margin-left: 8px; 
            border-left: 2px solid var(--accent-line); 
            padding-top: 5px; padding-bottom: 20px;
        }

        .issue-item { 
            position: relative; padding: 12px 0 12px 35px; 
            display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
        }
        .issue-item:hover { background-color: var(--hover-bg); margin-left: -20px; padding-left: 55px; width: 100%; border-radius: 4px;}

        .issue-item::before {
            content: ''; position: absolute; left: -6px; top: 50%; transform: translateY(-50%);
            width: 10px; height: 10px; border-radius: 50%;
            background-color: var(--dot-color, var(--default-dot)); 
            border: 3px solid var(--bg-color); z-index: 2;
        }
        
        .issue-item.is-commit::before { box-shadow: 0 0 8px var(--dot-color); } /* è®©å…‰æ™•é¢œè‰²ä¹Ÿè·Ÿéšæ ‡ç­¾ */
        .issue-item.closed::before { background-color: var(--text-dim) !important; box-shadow: none !important;}
        .issue-item.closed .issue-title a { color: var(--text-dim); text-decoration: line-through; }

        .issue-content { display: flex; align-items: center; gap: 12px; flex: 1; }

        .project-badge {
            font-size: 11px; padding: 2px 8px; border-radius: 4px;
            color: #23272e; background-color: var(--dot-color);
            font-family: "Consolas", monospace; font-weight: bold;
            min-width: 50px; text-align: center;
        }

        .issue-title a { text-decoration: none; color: var(--text-main); font-size: 15px; }
        .issue-title a:hover { color: #61afef; }

        .meta { 
            font-size: 13px; color: var(--text-dim); min-width: 180px; text-align: right;
            display: flex; justify-content: flex-end; gap: 15px; font-family: "Consolas", monospace;
        }

        #status-bar { text-align: center; font-size: 13px; margin-bottom: 20px; padding: 8px; border-radius: 6px; display: none; background: #21252b; color: #98c379;}
    </style>
</head>
<body>

    <div class="header">
        <h1>å”®åå·¥å…·å¼€å‘çœ‹æ¿</h1>
        <div class="header-actions">
            <a href="https://docs.dingtalk.com/i/nodes/vy20BglGWOeEwPNvTYvLj2brJA7depqY" target="_blank" class="btn btn-add">
                â• æéœ€æ±‚
            </a>
            <span onclick="forceRefresh()" class="btn btn-refresh">
                ğŸ”„ åˆ·æ–°
            </span>
        </div>
    </div>

    <div id="status-bar"></div>
    <div id="loading" style="text-align:center; color:#5c6370; margin-top: 40px; font-size: 14px;">æ­£åœ¨åŒæ­¥å¤šä»“åº“åŠ¨æ€...</div>
    
    <ul class="issue-list" id="container"></ul>

    <script>
        // ğŸ”‘ Token é…ç½®
        const t_head = 'ghp_'; 
        const t_body = 'KEu5mvAqyDMDuC1JbMEH42t11wAvIM3ZEIjg'; 

        // âœ… æ ¸å¿ƒé…ç½® (æ”¯æŒå¤šä»“åº“æ•°ç»„)
        const config = {
            owner: 'chengfengsunce',
            dashboardRepo: 'dashboard',   
            // ğŸ‘‡ è¿™é‡Œæ”¹æˆæ•°ç»„ï¼Œä»¥åæœ‰æ–°å·¥å…·ç›´æ¥åŠ åˆ°è¿™é‡Œ
            codeRepos: ['deepscan'], 
            token: t_head + t_body
        };

        const CACHE_KEY = 'auto_flow_data';
        const CACHE_TIME_KEY = 'auto_flow_time';
        const CACHE_DURATION = 60 * 1000; 

        // ğŸ¨ è‡ªåŠ¨ç”Ÿæˆé¢œè‰²çš„ç®—æ³• (æ ¹æ®æ–‡å­—ç®—å‡ºä¸€ä¸ªå›ºå®šé¢œè‰²)
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            // é€‰ç”¨æŸ”å’Œçš„äº®è‰²ç³»ï¼Œé¿å…å¤ªé»‘çœ‹ä¸æ¸…
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + "00000".substring(0, 6 - c.length) + c;
        }

        // ğŸ§  æ™ºèƒ½è§£æ Commit ä¿¡æ¯
        function parseCommitMessage(message, defaultRepoName) {
            // æ­£åˆ™åŒ¹é…ï¼šæŸ¥æ‰¾ [xxx] æˆ– ã€xxxã€‘ å¼€å¤´çš„æ ‡ç­¾
            const tagMatch = message.match(/^ã€(.*?)ã€‘|^\[(.*?)\]/);
            
            if (tagMatch) {
                // å¦‚æœæ‰¾åˆ°äº†æ ‡ç­¾ (ä¾‹å¦‚ "[å¤§å±]"), æå–æ–‡å­—ï¼Œå¹¶æŠŠæ­£æ–‡é‡Œçš„æ ‡ç­¾å»æ‰
                const tagName = tagMatch[1] || tagMatch[2];
                return {
                    name: tagName,
                    title: message.replace(tagMatch[0], '').trim(), // å»æ‰æ ‡ç­¾åçš„çº¯æ ‡é¢˜
                    color: stringToColor(tagName) // è‡ªåŠ¨ç”Ÿæˆé¢œè‰²
                };
            } else {
                // å¦‚æœæ²¡å†™æ ‡ç­¾ï¼Œå°±ç”¨ä»“åº“ååšé»˜è®¤æ ‡ç­¾
                return {
                    name: defaultRepoName, // ä¾‹å¦‚ deepscan
                    title: message,
                    color: '#61afef' // é»˜è®¤è“è‰²
                };
            }
        }

        async function fetchAllData(force = false) {
            const container = document.getElementById('container');
            const loading = document.getElementById('loading');
            
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const now = new Date().getTime();

            if (!force && cachedData && cachedTime && (now - cachedTime < CACHE_DURATION)) {
                renderList(JSON.parse(cachedData));
                showStatus('âœ” å·²åŠ è½½æœ¬åœ°ç¼“å­˜');
                loading.style.display = 'none';
                return;
            }

            container.innerHTML = ''; 
            loading.style.display = 'block';

            const headers = { 'Authorization': `token ${config.token}` };
            
            try {
                // 1. æŠ“å– Issues
                const issuesPromise = fetch(`https://api.github.com/repos/${config.owner}/${config.dashboardRepo}/issues?state=all&per_page=15`, { headers })
                    .then(res => res.json());

                // 2. æŠ“å–æ‰€æœ‰ä»£ç ä»“åº“çš„ Commits (æ”¯æŒå¤šä¸ª)
                const repoPromises = config.codeRepos.map(repo => 
                    fetch(`https://api.github.com/repos/${config.owner}/${repo}/commits?per_page=10`, { headers })
                        .then(res => res.json())
                        .then(commits => commits.map(c => {
                            // ğŸ”¥ è¿™é‡Œæ˜¯æ ¸å¿ƒï¼šæ™ºèƒ½è§£æ
                            const info = parseCommitMessage(c.commit.message, repo);
                            return {
                                id: c.sha.substring(0, 7),
                                title: info.title,           // å¹²å‡€çš„æ ‡é¢˜
                                updated_at: c.commit.author.date,
                                html_url: c.html_url,
                                is_commit: true,
                                project_name: info.name,     // åŠ¨æ€æ ‡ç­¾å
                                project_color: info.color    // åŠ¨æ€é¢œè‰²
                            };
                        }))
                );

                const [issues, ...commitsArrays] = await Promise.all([issuesPromise, ...repoPromises]);
                
                // å±•å¹³æ‰€æœ‰ä»“åº“çš„ commits
                const allCommits = commitsArrays.flat();

                // æ£€æŸ¥ Token é”™è¯¯
                if (issues.message === 'Bad credentials') throw new Error('Token å¤±æ•ˆ');

                const combined = [...issues, ...allCommits].sort((a, b) => {
                    const dateA = new Date(a.updated_at || a.commit?.author.date);
                    const dateB = new Date(b.updated_at || b.commit?.author.date);
                    return dateB - dateA;
                });

                localStorage.setItem(CACHE_KEY, JSON.stringify(combined));
                localStorage.setItem(CACHE_TIME_KEY, now);

                renderList(combined);
                loading.style.display = 'none';
                showStatus('âœ” å…¨å¹³å°åŒæ­¥æˆåŠŸ');

            } catch (e) { 
                console.error(e); 
                loading.innerText = 'åŒæ­¥å¤±è´¥ï¼šè¯·æ£€æŸ¥Tokenæˆ–ç½‘ç»œ';
            }
        }

        function renderList(data) {
            const container = document.getElementById('container');
            container.innerHTML = '';
            
            data.forEach(item => {
                if (item.pull_request) return;
                
                const li = document.createElement('li');
                li.className = item.is_commit ? 'issue-item is-commit' : (item.state === 'open' ? 'issue-item' : 'issue-item closed');
                
                let projectInfo = null;

                if (item.is_commit) {
                    // ä»£ç æäº¤ï¼šç›´æ¥ä½¿ç”¨æ™ºèƒ½è§£æå‡ºæ¥çš„é¡¹ç›®ä¿¡æ¯
                    projectInfo = { name: item.project_name, color: item.project_color };
                } else {
                    // Issueä»»åŠ¡ï¼šä¾ç„¶é€šè¿‡æ ‡ç­¾è¯†åˆ«
                    item.labels?.forEach(lbl => {
                        if (lbl.name.startsWith('é¡¹ç›®:')) {
                            projectInfo = { color: '#' + lbl.color, name: lbl.name.replace('é¡¹ç›®:', '') };
                        }
                    });
                }

                li.style.setProperty('--dot-color', projectInfo?.color || '#5c6370');
                const badgeHtml = projectInfo ? `<span class="project-badge">${projectInfo.name}</span>` : ``; 
                const date = new Date(item.updated_at || item.commit?.author.date);
                const timeStr = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;

                li.innerHTML = `
                    <div class="issue-content">
                        ${badgeHtml}
                        <div class="issue-title">
                            <a href="${item.html_url}" target="_blank">${item.title}</a>
                        </div>
                    </div>
                    <div class="meta">
                        <span>qiao</span>
                        <span>${timeStr}</span>
                    </div>
                `;
                container.appendChild(li);
            });
        }

        function forceRefresh() { fetchAllData(true); }
        fetchAllData();
    </script>
</body>
</html>
