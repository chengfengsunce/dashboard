<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”®åç ”å‘æ§åˆ¶å°</title>
    <style>
        /* --- å…¨å±€æ·±è‰²é»‘å®¢é£æ ·å¼ --- */
        body { background-color: #0d1117; color: #c9d1d9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        
        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        .header { border-bottom: 1px solid #30363d; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 18px; color: #58a6ff; }

        /* --- æŒ‰é’®ç»„æ ·å¼ --- */
        .header-actions { display: flex; gap: 10px; }
        .btn { text-decoration: none; padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; line-height: 20px; }
        .btn-refresh { background-color: #21262d; color: #c9d1d9; border: 1px solid #30363d; }
        .btn-refresh:hover { border-color: #8b949e; background-color: #30363d; }
        .btn-add { background-color: #238636; color: #ffffff; border: 1px solid rgba(240,246,252,0.1); }
        .btn-add:hover { background-color: #2ea043; }

        /* --- åˆ—è¡¨åŒºåŸŸ --- */
        .issue-list { list-style: none; padding: 0; margin: 0; }
        .issue-item { background-color: #161b22; border: 1px solid #30363d; border-radius: 6px; padding: 16px; margin-bottom: 12px; transition: 0.2s; }
        .issue-item:hover { border-color: #8b949e; }
        .issue-title { font-size: 16px; font-weight: 600; color: #e6edf3; margin-bottom: 8px; display: flex; align-items: center; }
        
        /* --- æ ‡ç­¾ç³»ç»Ÿ --- */
        .labels { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .label { font-size: 12px; padding: 2px 8px; border-radius: 2em; border: 1px solid transparent; color: #fff; font-weight: 500; text-shadow: 0 0 1px rgba(0,0,0,0.5); }

        /* --- åº•éƒ¨å…ƒæ•°æ® --- */
        .meta { margin-top: 12px; font-size: 12px; color: #8b949e; display: flex; justify-content: space-between; }
        
        /* --- çŠ¶æ€æç¤ºæ¡ --- */
        #status-bar { text-align: center; font-size: 12px; margin-bottom: 10px; padding: 5px; border-radius: 4px; display: none; }
        .status-warn { background: rgba(210, 153, 34, 0.2); color: #d29922; border: 1px solid rgba(210, 153, 34, 0.4); }
        .status-cache { background: rgba(56, 139, 253, 0.1); color: #79c0ff; border: 1px solid rgba(56, 139, 253, 0.4); }
    </style>
</head>
<body>

    <div class="header">
        <h1>ğŸš€ ç ”å‘å®æ—¶çœ‹æ¿</h1>
        <div class="header-actions">
            <a href="https://docs.dingtalk.com/i/nodes/vy20BglGWOeEwPNvTYvLj2brJA7depqY?iframeQuery=entrance%3Ddata%26sheetId%3DhERWDMS%26viewId%3DqvGDAH2" target="_blank" class="btn btn-add">
                â• æéœ€æ±‚
            </a>
            <span onclick="forceRefresh()" class="btn btn-refresh">
                ğŸ”„ åˆ·æ–°
            </span>
        </div>
    </div>

    <div id="status-bar"></div>
    <div id="loading" style="text-align:center; color:#58a6ff; margin-top: 20px;">ğŸ“¡ æ­£åœ¨è¿æ¥ GitHub...</div>
    <ul class="issue-list" id="container"></ul>

    <script>
        // âœ… é…ç½®åŒº
        const owner = 'chengfengsunce'; 
        const repo = 'dashboard'; 
        
        // âš™ï¸ ç¼“å­˜é…ç½® (60ç§’å†…ä¸é‡å¤è¯·æ±‚ï¼Œä¿æŠ¤é¢åº¦)
        const CACHE_KEY = 'dashboard_data';
        const CACHE_TIME_KEY = 'dashboard_time';
        const CACHE_DURATION = 60 * 1000; 

        // âš™ï¸ Tokené…ç½® (ä»æœ¬åœ°è¯»å–ï¼Œç»å¯¹å®‰å…¨)
        const TOKEN_KEY = 'github_token';

        async function loadIssues(force = false) {
            const container = document.getElementById('container');
            const loading = document.getElementById('loading');
            const statusBar = document.getElementById('status-bar');

            // 1. æ£€æŸ¥ç¼“å­˜ (å¦‚æœæ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œåˆ™è·³è¿‡æ­¤æ­¥)
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const now = new Date().getTime();

            if (!force && cachedData && cachedTime && (now - cachedTime < CACHE_DURATION)) {
                console.log('ğŸš€ å‘½ä¸­ç¼“å­˜ï¼ŒèŠ‚çœä¸€æ¬¡è¯·æ±‚');
                renderList(JSON.parse(cachedData));
                showStatus('âš¡ï¸ æ•°æ®æ¥è‡ªç¼“å­˜ (å®æ—¶æ€§ < 1åˆ†é’Ÿ)', 'status-cache');
                loading.style.display = 'none';
                return;
            }

            // 2. å‡†å¤‡è¯·æ±‚ (æ£€æŸ¥æœ‰æ²¡æœ‰Token)
            container.innerHTML = ''; 
            loading.style.display = 'block';
            statusBar.style.display = 'none';

            const localToken = localStorage.getItem(TOKEN_KEY);
            const headers = localToken ? { 'Authorization': `token ${localToken}` } : {};
            
            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/issues?state=all&sort=updated&direction=desc&per_page=20`;
                const response = await fetch(url, { headers: headers }); // å¸¦ä¸ŠToken(å¦‚æœæœ‰)
                
                // 3. å¤„ç†é™æµ (403)
                if (response.status === 403) {
                    if (cachedData) {
                        renderList(JSON.parse(cachedData));
                        showStatus('âš ï¸ è®¿é—®å¤ªå¿«è§¦å‘é™æµï¼Œå·²å±•ç¤ºå†å²æ•°æ®', 'status-warn');
                    } else {
                        loading.innerHTML = 'âš ï¸ è§¦å‘ GitHub é™æµä¸”æ— ç¼“å­˜ï¼Œè¯·ä¼‘æ¯ä¸€ä¼šå†è¯•';
                    }
                    return;
                }

                // 4. è¯·æ±‚æˆåŠŸ
                const data = await response.json();
                
                // å†™å…¥ç¼“å­˜
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIME_KEY, now);

                renderList(data);
                loading.style.display = 'none';
                if(localToken) showStatus('ğŸ”“ å·²å¯ç”¨ Token åŠ é€Ÿæ¨¡å¼', 'status-cache');

            } catch (e) { 
                // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿå°è¯•è¯»å–ç¼“å­˜
                if (cachedData) {
                    renderList(JSON.parse(cachedData));
                    showStatus('âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå·²å±•ç¤ºå†å²æ•°æ®', 'status-warn');
                } else {
                    loading.innerText = 'âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ'; 
                }
                console.error(e); 
            }
        }

        // æ¸²æŸ“åˆ—è¡¨å‡½æ•°
        function renderList(data) {
            const container = document.getElementById('container');
            container.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#8b949e">æš‚æ— ä»»åŠ¡<br>è¯·å» GitHub Issues æ–°å»ºä»»åŠ¡</div>';
                return;
            }

            data.forEach(issue => {
                if (issue.pull_request) return;
                const li = document.createElement('li');
                li.className = 'issue-item';
                
                let labelHtml = '';
                issue.labels.forEach(lbl => { 
                    const color = '#' + lbl.color;
                    labelHtml += `<span class="label" style="background-color:${color}; border-color:${color}">${lbl.name}</span>`; 
                });

                const stateIcon = issue.state === 'open' ? 'ğŸŸ¢' : 'ğŸŸ£';
                
                li.innerHTML = `
                    <div class="issue-title">
                        <a href="${issue.html_url}" target="_blank" style="text-decoration:none; color:inherit; display:flex; align-items:center; width:100%">
                            ${stateIcon} <span style="margin-left:8px">${issue.title}</span>
                        </a>
                    </div>
                    <div class="labels">${labelHtml}</div>
                    <div class="meta">
                        <span>#${issue.number}</span>
                        <span>ğŸ•’ ${new Date(issue.updated_at).toLocaleDateString()}</span>
                    </div>
                `;
                container.appendChild(li);
            });
        }

        function showStatus(msg, className) {
            const bar = document.getElementById('status-bar');
            bar.innerText = msg;
            bar.className = className;
            bar.style.display = 'block';
        }

        // å¼ºåˆ¶åˆ·æ–° (å¿½ç•¥ç¼“å­˜)
        function forceRefresh() {
            loadIssues(true);
        }
        
        // é¦–æ¬¡åŠ è½½
        loadIssues();
    </script>
</body>
</html>
