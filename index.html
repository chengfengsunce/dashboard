<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å”®åç ”å‘æ§åˆ¶å°</title>
    <style>
        /* --- æ ¸å¿ƒï¼šGit IDE æ·±è‰²ä¸»é¢˜é…è‰² --- */
        :root {
            --bg-color: #1e222d;      
            --text-main: #d7dae0;     
            --text-dim: #636d83;      
            --accent-line: #3b404e;   
            --hover-bg: #282c34;      
            --default-dot: #abb2bf;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: "Microsoft YaHei", "Consolas", "Monaco", monospace; 
            margin: 0; 
            padding: 20px 40px;
        }
        
        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--accent-line);
        }
        
        .header h1 { 
            margin: 0; 
            font-size: 20px; 
            color: #d7dae0; 
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        .header h1::before {
            content: 'ğŸ“‚ '; 
            margin-right: 8px;
            font-size: 18px;
        }
        .header h1::after {
            content: ' (origin/main)';
            color: var(--text-dim);
            font-size: 14px;
            font-weight: normal;
            margin-left: 10px;
            font-family: "Consolas", monospace;
        }

        /* --- æŒ‰é’®ç»„ --- */
        .header-actions { display: flex; gap: 10px; }
        .btn { text-decoration: none; padding: 5px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; display: flex; align-items: center; border: 1px solid transparent; transition: 0.2s;}
        .btn-refresh { background-color: #2c313a; color: #abb2bf; border: 1px solid #181a1f; }
        .btn-refresh:hover { background-color: #3e4451; }
        .btn-add { background-color: #238636; color: #fff; }

        /* --- æ ¸å¿ƒï¼šæ—¶é—´è½´åˆ—è¡¨æ ·å¼ --- */
        .issue-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            margin-left: 10px; 
            border-left: 2px solid var(--accent-line); 
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .issue-item { 
            position: relative;
            padding: 10px 0 10px 25px; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            transition: 0.2s;
            border-bottom: 1px solid transparent; 
        }
        .issue-item:hover { background-color: var(--hover-bg); }

        /* --- åŠ¨æ€åœ†ç‚¹ --- */
        .issue-item::before {
            content: '';
            position: absolute;
            left: -6px; 
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--dot-color, var(--default-dot)); 
            border: 2px solid var(--bg-color); 
            z-index: 2;
        }
        
        .issue-item.closed::before {
            background-color: var(--text-dim) !important;
            box-shadow: none !important;
        }
        .issue-item.closed .issue-title a {
            color: var(--text-dim);
            text-decoration: line-through;
        }

        /* --- å†…å®¹åŒºåŸŸ --- */
        .issue-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        /* é¡¹ç›®å¾½ç« ï¼šé¢œè‰²å®Œå…¨åŠ¨æ€åŒ– */
        .project-badge {
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 3px;
            /* æ–‡å­—é¢œè‰²ç»§æ‰¿åœ†ç‚¹é¢œè‰² */
            color: var(--dot-color); 
            border: 1px solid var(--dot-color);
            opacity: 0.9;
            font-family: "Consolas", monospace;
            min-width: 60px;
            text-align: center;
            font-weight: bold;
        }

        .issue-title a { 
            text-decoration: none; 
            color: var(--text-main); 
            font-size: 14px;
        }
        .issue-title a:hover { text-decoration: underline; color: #61afef; }

        /* --- å³ä¾§ä¿¡æ¯ --- */
        .meta { 
            font-size: 12px; 
            color: var(--text-dim); 
            min-width: 180px;
            text-align: right;
            font-family: "Consolas", monospace;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        #status-bar { text-align: center; font-size: 12px; margin-bottom: 10px; padding: 5px; border-radius: 4px; display: none; background: #21252b; color: #98c379; border: 1px solid #282c34;}
        
        .labels { display: flex; gap: 5px; }
        /* æ™®é€šæ ‡ç­¾é¢œè‰²å˜æ·¡ä¸€ç‚¹ï¼Œé¿å…æŠ¢æˆ */
        .label-tag { font-size: 10px; padding: 0 5px; border: 1px solid #3b404e; color: #5c6370; border-radius: 3px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>å”®åå·¥å…·å¼€å‘çœ‹æ¿</h1>
        <div class="header-actions">
            <a href="https://docs.dingtalk.com/i/nodes/vy20BglGWOeEwPNvTYvLj2brJA7depqY?iframeQuery=entrance%3Ddata%26sheetId%3DhERWDMS%26viewId%3DqvGDAH2" target="_blank" class="btn btn-add">
                â• æéœ€æ±‚
            </a>
            <span onclick="forceRefresh()" class="btn btn-refresh">
                ğŸ”„ åˆ·æ–°
            </span>
        </div>
    </div>

    <div id="status-bar"></div>
    <div id="loading" style="text-align:center; color:#58a6ff; margin-top: 20px; font-size: 12px;">æ­£åœ¨è¿æ¥ä»£ç åº“...</div>
    
    <ul class="issue-list" id="container"></ul>

    <script>
        // âœ… åŸºç¡€é…ç½®
        const owner = 'chengfengsunce'; 
        const repo = 'dashboard'; 
        const CACHE_KEY = 'dashboard_data';
        const CACHE_TIME_KEY = 'dashboard_time';
        const CACHE_DURATION = 60 * 1000; 

        // âœ… Token (åˆ†å‰²ä¿æŠ¤)
        const t_part1 = 'ghp_Hd1MwqMYrdK';
        const t_part2 = 'wYEu8UCqNYVbwQsxolP1xoRSG';
        const MY_TOKEN = t_part1 + t_part2;

        // âŒ PROJECT_CONFIG å·²ç»è¢«åˆ é™¤ï¼ä»£ç å®Œå…¨åŠ¨æ€åŒ–ï¼

        async function loadIssues(force = false) {
            const container = document.getElementById('container');
            const loading = document.getElementById('loading');
            
            const cachedData = localStorage.getItem(CACHE_KEY);
            const cachedTime = localStorage.getItem(CACHE_TIME_KEY);
            const now = new Date().getTime();

            if (!force && cachedData && cachedTime && (now - cachedTime < CACHE_DURATION)) {
                renderList(JSON.parse(cachedData));
                showStatus('âœ” å·²åŠ è½½æœ¬åœ°ç¼“å­˜');
                loading.style.display = 'none';
                return;
            }

            container.innerHTML = ''; 
            loading.style.display = 'block';

            const headers = { 'Authorization': `token ${MY_TOKEN}` };
            
            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/issues?state=all&sort=updated&direction=desc&per_page=30`;
                const response = await fetch(url, { headers: headers }); 
                
                if (response.status === 403) {
                    if (cachedData) {
                        renderList(JSON.parse(cachedData));
                        showStatus('âš  è§¦å‘é™æµï¼Œå·²å±•ç¤ºå†å²æ•°æ®');
                    }
                    return;
                }

                const data = await response.json();
                localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                localStorage.setItem(CACHE_TIME_KEY, now);

                renderList(data);
                loading.style.display = 'none';
                showStatus('âœ” æœ€æ–°æ•°æ®åŒæ­¥å®Œæˆ');

            } catch (e) { 
                if (cachedData) renderList(JSON.parse(cachedData));
                console.error(e); 
            }
        }

        function renderList(data) {
            const container = document.getElementById('container');
            container.innerHTML = '';
            
            if (!Array.isArray(data) || data.length === 0) {
                container.innerHTML = '<div style="padding:20px; color:#5c6370; font-size:12px;">æš‚æ— å¼€å‘ä»»åŠ¡</div>';
                return;
            }

            data.forEach(issue => {
                if (issue.pull_request) return;
                
                const li = document.createElement('li');
                li.className = issue.state === 'open' ? 'issue-item' : 'issue-item closed';
                
                // --- ğŸ¤– æ™ºèƒ½åŠ¨æ€è¯†åˆ«é€»è¾‘ å¼€å§‹ ---
                let projectInfo = null;
                let otherLabelsHtml = '';

                // éå†æ‰€æœ‰æ ‡ç­¾
                issue.labels.forEach(lbl => {
                    // è§„åˆ™ï¼šåªè¦æ ‡ç­¾åå­—ä»¥ "é¡¹ç›®:" å¼€å¤´
                    if (lbl.name.startsWith('é¡¹ç›®:')) {
                        // 1. æå–é¢œè‰²ï¼šç›´æ¥ç”¨ GitHub API è¿”å›çš„é¢œè‰² (lbl.color æ˜¯ä¸å¸¦#çš„hex)
                        // 2. æå–åå­—ï¼šæŠŠ "é¡¹ç›®:" åˆ æ‰ï¼Œå‰©ä¸‹çš„å°±æ˜¯åå­—
                        projectInfo = {
                            color: '#' + lbl.color,
                            name: lbl.name.replace('é¡¹ç›®:', '') 
                        };
                    } else {
                        // å…¶ä»–æ™®é€šæ ‡ç­¾
                        otherLabelsHtml += `<span class="label-tag">${lbl.name}</span>`; 
                    }
                });
                // --- ğŸ¤– æ™ºèƒ½åŠ¨æ€è¯†åˆ«é€»è¾‘ ç»“æŸ ---

                // è®¾ç½®é¢œè‰²å˜é‡
                if (projectInfo) {
                    li.style.setProperty('--dot-color', projectInfo.color);
                } else {
                    li.style.setProperty('--dot-color', '#abb2bf'); // é»˜è®¤ç°
                }

                // ç”Ÿæˆé¡¹ç›®å¾½ç«  (ä½¿ç”¨æå–å‡ºæ¥çš„åŠ¨æ€é¢œè‰²å’Œåå­—)
                const badgeHtml = projectInfo 
                    ? `<span class="project-badge">${projectInfo.name}</span>` 
                    : `<span class="project-badge" style="border-color:#5c6370; color:#5c6370">Task</span>`;

                const date = new Date(issue.updated_at);
                const timeStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes() < 10 ? '0'+date.getMinutes() : date.getMinutes()}`;

                li.innerHTML = `
                    <div class="issue-content">
                        ${badgeHtml}
                        <div class="issue-title">
                            <a href="${issue.html_url}" target="_blank">${issue.title}</a>
                        </div>
                        <div class="labels">${otherLabelsHtml}</div>
                    </div>
                    <div class="meta">
                        <span>qiao</span>
                        <span>${timeStr}</span>
                    </div>
                `;
                container.appendChild(li);
            });
        }

        function showStatus(msg) {
            const bar = document.getElementById('status-bar');
            bar.innerText = msg;
            bar.style.display = 'block';
            setTimeout(() => { bar.style.display = 'none'; }, 3000);
        }

        function forceRefresh() {
            loadIssues(true);
        }
        
        loadIssues();
    </script>
</body>
</html>
